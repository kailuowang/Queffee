(function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}},n=[].slice;e=null,typeof exports!="undefined"&&exports!==null?e=exports:e=this.queffee={},e.Node=function(){function e(e,n,r){this.array=e,this.index=n,this.comp=r!=null?r:function(e,t){return e>t},this._valid=t(this._valid,this),this._comp=t(this._comp,this),this._isRoot=t(this._isRoot,this),this._swap=t(this._swap,this),this._findSmallerChildren=t(this._findSmallerChildren,this),this._child=t(this._child,this),this.siftUp=t(this.siftUp,this),this.siftDown=t(this.siftDown,this),this.heapify=t(this.heapify,this),this.parent=t(this.parent,this),this.right=t(this.right,this),this.left=t(this.left,this),this.value=t(this.value,this)}return e.prototype.value=function(e){return e!=null&&this._valid()?this.array[this.index]=e:this.array[this.index]},e.prototype.left=function(){var e;return(e=this._left)!=null?e:this._left=this._child(2*this.index+1)},e.prototype.right=function(){var e;return(e=this._right)!=null?e:this._right=this._child(2*this.index+2)},e.prototype.parent=function(){var t;return(t=this._parent)!=null?t:this._parent=new e(this.array,Math.floor(this.index/2),this.comp)},e.prototype.heapify=function(){return this.left()!=null&&this.left().heapify(),this.right()!=null&&this.right().heapify(),this.siftDown()},e.prototype.siftDown=function(){var e;e=this._findSmallerChildren();if(e!=null&&this._comp(e,this))return this._swap(e),e.siftDown()},e.prototype.siftUp=function(){if(!this._isRoot()&&this._comp(this,this.parent()))return this._swap(this.parent()),this.parent().siftUp()},e.prototype._child=function(t){return t<this.array.length?new e(this.array,t,this.comp):null},e.prototype._findSmallerChildren=function(){return this.left()!=null&&this.right()!=null?this._comp(this.left(),this.right())?this.left():this.right():this.left()!=null?this.left():this.right()},e.prototype._swap=function(e){var t;return t=this.value(),this.value(e.value()),e.value(t)},e.prototype._isRoot=function(){return this.index===0},e.prototype._comp=function(e,t){return this.comp(e.value(),t.value())},e.prototype._valid=function(){return this.index<this.array.length},e}(),e.Heap=function(){function n(e,n){this._array=e!=null?e:[],this.comp=n!=null?n:function(e,t){return e>t},this._init=t(this._init,this),this._last=t(this._last,this),this.reorder=t(this.reorder,this),this.insert=t(this.insert,this),this.extractTop=t(this.extractTop,this),this.top=t(this.top,this),this.size=t(this.size,this),this._init(),this.reorder()}return n.prototype.size=function(){return this._array.length},n.prototype.top=function(){return this._root.value()},n.prototype.extractTop=function(){var e,t;return t=this.top(),e=this._array.pop(),this._init(),this._root.value(e),this._root.siftDown(),t},n.prototype.insert=function(e){return this._array.push(e),this._last().siftUp()},n.prototype.reorder=function(){return this._root.heapify()},n.prototype._last=function(){return new e.Node(this._array,this._array.length-1,this.comp)},n.prototype._init=function(){return this._root=new e.Node(this._array,0,this.comp)},n}(),e.Job=function(){function e(e,n){var r;this._perform=e,n==null&&(n={}),this._try=t(this._try,this),this._done=t(this._done,this),this._perform_job=t(this._perform_job,this),this.perform=t(this.perform,this),this.timeout=t(this.timeout,this),this.priority=t(this.priority,this),r=[n.priority,n.timeout],this._priority=r[0],this._timeout=r[1]}return e.prototype.priority=function(){return this._try(this._priority)},e.prototype.timeout=function(){return this._try(this._timeout)},e.prototype.perform=function(e){this.running=!0,this._onJobDone=e,this._perform_job();if(this.timeout()!=null)return setTimeout(this._done,this.timeout())},e.prototype._perform_job=function(){var e=this;if(this._perform.length===1)return this._perform(this._done);if(this._perform.length===0)return setTimeout(function(){var t;return t=e._perform(),(t!=null?t.then:void 0)!=null?t.then(e._done):e._done()});throw""+this._perform+" should be either an async function that takes in callback function as a parameter or a synchronized function that does take have any arguments."},e.prototype._done=function(){if(this.running)return this.running=!1,typeof this._onJobDone=="function"?this._onJobDone():void 0},e.prototype._try=function(e){return typeof e=="function"?typeof e=="function"?e():void 0:e},e}(),e.Q=function(){function r(e){e==null&&(e=[]),this._newJobsAdded=t(this._newJobsAdded,this),this._initHeap=t(this._initHeap,this),this._priorityBySequence=t(this._priorityBySequence,this),this.clear=t(this.clear,this),this.size=t(this.size,this),this.reorder=t(this.reorder,this),this.dequeue=t(this.dequeue,this),this.enQ=t(this.enQ,this),this.enqueue=t(this.enqueue,this),this.jobsAdded=t(this.jobsAdded,this),this._initHeap(e),this.newJobsAddedHandler=[]}return r._compareJob=function(e,t){return e.priority()>t.priority()},r.prototype.jobsAdded=function(e){return this.newJobsAddedHandler.push(e)},r.prototype.enqueue=function(){var e,t,r,i;t=1<=arguments.length?n.call(arguments,0):[];for(r=0,i=t.length;r<i;r++)e=t[r],this._heap.insert(e);return this._newJobsAdded()},r.prototype.enQ=function(t,n){var r;return n==null&&(n={}),(r=n.priority)==null&&(n.priority=this._priorityBySequence()),this.enqueue(new e.Job(t,n))},r.prototype.dequeue=function(){return this._heap.extractTop()},r.prototype.reorder=function(){return this._heap.reorder()},r.prototype.size=function(){return this._heap.size()},r.prototype.clear=function(){return this._initHeap([])},r.prototype._priorityBySequence=function(){return-1-this.size()},r.prototype._initHeap=function(t){return this._heap=new e.Heap(t,e.Q._compareJob)},r.prototype._newJobsAdded=function(){var e,t,n,r,i;r=this.newJobsAddedHandler,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e());return i},r}.call(this),e.Worker=function(){function e(e,n,r){this.q=e,this.onIdle=n,this._turnedOff=r!=null?r:!1,this._pickupJob=t(this._pickupJob,this),this._kickOffJob=t(this._kickOffJob,this),this._onJobDone=t(this._onJobDone,this),this._work=t(this._work,this),this.retry=t(this.retry,this),this.idle=t(this.idle,this),this.stop=t(this.stop,this),this.start=t(this.start,this),this._job=null,this.q.jobsAdded(this._work)}return e.prototype.start=function(){return this._turnedOff=!1,this._work()},e.prototype.stop=function(){return this._turnedOff=!0},e.prototype.idle=function(){return this._job==null},e.prototype.retry=function(){if(!this.idle())return this._kickOffJob()},e.prototype._work=function(){if(this.idle()&&!this._turnedOff)return this._pickupJob(),this.idle()?typeof this.onIdle=="function"?this.onIdle():void 0:this._kickOffJob()},e.prototype._onJobDone=function(){return this._job=null,this._work()},e.prototype._kickOffJob=function(){return this._job.perform(this._onJobDone)},e.prototype._pickupJob=function(){return this._job=this.q.dequeue()},e}(),e.CollectionWorkQ=function(){function n(e){this._itemDone=t(this._itemDone,this),this._createJob=t(this._createJob,this),this._createJobs=t(this._createJobs,this),this.start=t(this.start,this),this.collection=e.collection,this.operation=e.operation,this.onProgress=e.onProgress,this.onFinish=e.onFinish}return n.prototype.start=function(){var t;return t=new e.Q(this._createJobs()),(new e.Worker(t,this.onFinish)).start()},n.prototype._createJobs=function(){var e,t,n,r,i,s;i=this.collection,s=[];for(e=n=0,r=i.length;n<r;e=++n)t=i[e],s.push(this._createJob(t,e));return s},n.prototype._createJob=function(t,n){var r,i=this;return r=typeof this.operation=="string"?function(e){return t[i.operation](function(){return i._itemDone(n,e)})}:function(e){return i.operation(t,function(){return i._itemDone(n,e)})},new e.Job(r,{priority:-n})},n.prototype._itemDone=function(e,t){return typeof this.onProgress=="function"&&this.onProgress(e+1),t()},n}()}).call(this);